import{a as f,d as D}from"./chunk-PCYDMJPV.js";import{a as r,b as l}from"./chunk-JHI3MBHO.js";var N=(()=>{let d=class d{sumLeistungen(t=[]){return t.reduce((e,n)=>{let i=Number(n.menge)||0,s=Number(n.einzelpreis)||0;return e+i*s},0)}sumMaterial(t=[]){return t.reduce((e,n)=>{let i=Number(n.menge)||0,s=Number(n.einzelpreis)||0,u=(n.typ??"").toLowerCase();return u==="ersatzteil"||u==="material"?e+i*s:e},0)}ensureDate(t){if(!t)return;let e=t instanceof Date?t:new Date(t);return Number.isNaN(e.getTime())?void 0:e}round(t){return Math.round((t+Number.EPSILON)*100)/100}normalizeLeistungen(t){return(t??[]).map(e=>l(r({},e),{menge:Number(e.menge)||0,einzelpreis:Number(e.einzelpreis)||0}))}calcBruttoFromNetto(t){let e=Number(t??0);return e?this.round(e*(1+this.VAT_RATE)):0}recalculateProject(t){let e=this.ensureDate(t.letzteAenderung)??new Date,n=(t.termine??[]).map(a=>l(r({},a),{datum:this.ensureDate(a.datum)??new Date(a.datum??new Date)})),i=(t.angebote??[]).map(a=>{let g=this.normalizeLeistungen(a.leistungen),o=this.ensureDate(a.datum)??new Date,c=a.betragNetto??this.sumLeistungen(g);return l(r({},a),{datum:o,leistungen:g,betragNetto:this.round(c)})}),s=(t.rechnungen??[]).map(a=>{let g=this.normalizeLeistungen(a.leistungen),o=this.ensureDate(a.datum)??new Date,c=this.ensureDate(a.faelligAm),z=a.betragNetto??this.sumLeistungen(g),p=a.betragBrutto??this.calcBruttoFromNetto(z);return l(r({},a),{datum:o,faelligAm:c,leistungen:g,betragNetto:this.round(z),betragBrutto:this.round(p)})}),u=this.round(s.reduce((a,g)=>a+(g.betragNetto??0),0)),m=this.round(s.reduce((a,g)=>a+this.sumMaterial(g.leistungen??[]),0)),h=this.round(s.reduce((a,g)=>{let o=(g.status??"").toLowerCase();return o.includes("bezahlt")||o.includes("storniert")?a:a+(g.betragBrutto??g.betragNetto??0)},0));return l(r({},t),{letzteAenderung:e,termine:n,angebote:i,rechnungen:s,umsatz:u,ausgaben:m,offenerBetrag:h})}getLeistungskatalog(){return this._leistungskatalog()}findLeistungById(t){return this._leistungskatalog().find(e=>e.id===t)}addLeistungskatalogEintrag(t){let e=this.createLeistungId(),n=t.nummer?.trim()||e,i={id:e,nummer:n,titel:t.titel?.trim()||"Neue Leistung",beschreibung:t.beschreibung?.trim()||void 0,typ:t.typ,menge:Number(t.menge??1)||1,einheit:t.einheit?.trim()||"Einheit",einzelpreis:Number(t.einzelpreis)||0,katalogId:e,zuletztAktualisiert:new Date},s=[...this._leistungskatalog(),i];return this._leistungskatalog.set(s),this.saveLeistungen(),i}constructor(){this.STORAGE_KEY_PROJEKTE="dummy.projects.v1",this.STORAGE_KEY_LEISTUNGEN="dummy.services.v1",this.VAT_RATE=.19,this._projekte=D(this.loadProjects()??[]),this._leistungskatalog=D(this.loadLeistungen()??[]),this.projektesig=this._projekte.asReadonly(),this.leistungskatalogsig=this._leistungskatalog.asReadonly(),this.createProjects(),this.createLeistungskatalog()}createProjects(t=!1){if(!t&&this._projekte().length)return;let e=[{name:"Badsanierung Altbau Friedrichshain",nr:"24-PL-011",status:"Abgeschlossen",ausfuehrungsort:"M\xFCggelstra\xDFe 18, 10247 Berlin",kunde:"Frank K\xF6hler",letzteAenderung:new Date("2025-03-17"),beschreibung:"Komplette Badsanierung inkl. neuer Rohrf\xFChrung, Sanit\xE4rkeramik und Armaturen.",umsatz:7704,ausgaben:4980,offenerBetrag:0,termine:[{datum:new Date("2025-02-14"),vonBis:"08:00 - 16:30",status:"Erledigt",name:"Endabnahme Sanit\xE4r",mitarbeiter:"CM"}],angebote:[{datum:new Date("2025-01-28"),nr:"AN-24028",status:"Akzeptiert",name:"Bad Komplettangebot",erstelltVon:"CM",leistungen:[{typ:"Dienstleistung",titel:"Aufma\xDF und Planung Sanit\xE4r",beschreibung:"Vorbereitung der Leitungsf\xFChrung",menge:12,einheit:"Std",einzelpreis:78},{typ:"Dienstleistung",titel:"Montage Sanit\xE4rkeramik",beschreibung:"Installation WC, Waschtisch und Dusche",menge:26,einheit:"Std",einzelpreis:84},{typ:"Ersatzteil",titel:"Rohrmaterial Kupfer & Fittings",menge:1,einheit:"Pauschal",einzelpreis:1200},{typ:"Ersatzteil",titel:"Sanit\xE4rausstattung Komfort",menge:1,einheit:"Pauschal",einzelpreis:2950}],betragNetto:7270}],rechnungen:[{datum:new Date("2025-03-05"),nr:"RE-24089",status:"Bezahlt",leistungen:[{typ:"Dienstleistung",titel:"Demontage Altinstallation",menge:14,einheit:"Std",einzelpreis:78},{typ:"Dienstleistung",titel:"Neuinstallation Sanit\xE4rleitungen",menge:28,einheit:"Std",einzelpreis:84},{typ:"Ersatzteil",titel:"Rohrmaterial Kupfer",menge:1,einheit:"Pauschal",einzelpreis:1280},{typ:"Ersatzteil",titel:"Badm\xF6bel & Armaturen",menge:1,einheit:"Pauschal",einzelpreis:2980}],betragNetto:7704,betragBrutto:9166.76,faelligAm:new Date("2025-03-19")}]},{name:"Heizungsmodernisierung Prenzlauer Berg",nr:"24-PL-024",status:"In Arbeit",ausfuehrungsort:"Sch\xF6nhauser Allee 87, 10439 Berlin",kunde:"Sabine Hoffmann",letzteAenderung:new Date("2025-05-10"),beschreibung:"Umr\xFCstung der Heizungsanlage auf eine effiziente Brennwerttherme inkl. Heizkreisverteiler.",umsatz:5818,ausgaben:7390,offenerBetrag:6934.42,termine:[{datum:new Date("2025-03-20"),vonBis:"12:30 - 17:00",status:"Best\xE4tigt",name:"Hydraulischer Abgleich",mitarbeiter:"LZ"}],angebote:[{datum:new Date("2025-03-10"),nr:"AN-24052",status:"Akzeptiert",name:"Modernisierung Heizungsanlage",erstelltVon:"LZ",leistungen:[{typ:"Dienstleistung",titel:"Demontage Altanlage",beschreibung:"Abbau bestehender Kesselanlage",menge:18,einheit:"Std",einzelpreis:82},{typ:"Dienstleistung",titel:"Montage Brennwerttherme",beschreibung:"Installation inkl. Abgassystem",menge:32,einheit:"Std",einzelpreis:96},{typ:"Ersatzteil",titel:"Brennwerttherme Komplettset",menge:1,einheit:"Stk",einzelpreis:7400},{typ:"Ersatzteil",titel:"Heizkreisverteiler 6-fach",menge:1,einheit:"Stk",einzelpreis:1850}],betragNetto:13798}],rechnungen:[{datum:new Date("2025-03-28"),nr:"RE-24073",status:"Offen",leistungen:[{typ:"Dienstleistung",titel:"Rohinstallation Heizkreis",menge:26,einheit:"Std",einzelpreis:94},{typ:"Dienstleistung",titel:"Inbetriebnahme Heizung",menge:12,einheit:"Std",einzelpreis:102},{typ:"Ersatzteil",titel:"Pufferspeicher 200l",menge:1,einheit:"Stk",einzelpreis:2150}],betragNetto:5818,betragBrutto:6934.42,faelligAm:new Date("2025-04-27")}]},{name:"W\xE4rmepumpeninstallation Kreuzberg",nr:"24-PL-037",status:"Geplant",ausfuehrungsort:"Gneisenaustra\xDFe 42, 10961 Berlin",kunde:"Bau GmbH M\xFCller",letzteAenderung:new Date("2025-09-12"),beschreibung:"Planung und Installation einer Luft-Wasser-W\xE4rmepumpe mit Speicher.",umsatz:0,ausgaben:0,offenerBetrag:11885.24,termine:[{datum:new Date("2025-04-02"),vonBis:"09:00 - 11:00",status:"Geplant",name:"Technische Abstimmung",mitarbeiter:"AN"}],angebote:[{datum:new Date("2025-03-29"),nr:"AN-24088",status:"Versendet",name:"W\xE4rmepumpen-Komplettpaket",erstelltVon:"AN",leistungen:[{typ:"Dienstleistung",titel:"Demontage Altanlage",menge:16,einheit:"Std",einzelpreis:82},{typ:"Dienstleistung",titel:"Installation W\xE4rmepumpe",menge:24,einheit:"Std",einzelpreis:96},{typ:"Ersatzteil",titel:"W\xE4rmepumpenset 12 kW",menge:1,einheit:"Stk",einzelpreis:5200},{typ:"Ersatzteil",titel:"Hydraulikmodul & Speicher",menge:1,einheit:"Pauschal",einzelpreis:1180}],betragNetto:9996}],rechnungen:[]},{name:"Badsanierung Mitte",nr:"24-PL-058",status:"In Arbeit",ausfuehrungsort:"Torstra\xDFe 78, 10119 Berlin",kunde:"Lars Neumann",letzteAenderung:new Date("2025-10-05"),beschreibung:"Komplettsanierung eines Badezimmers inkl. bodengleicher Dusche.",umsatz:6120,ausgaben:5280,offenerBetrag:7282.8,termine:[{datum:new Date("2025-03-22"),vonBis:"08:00 - 16:00",status:"Geplant",name:"Demontage Altbad",mitarbeiter:"CM"}],angebote:[{datum:new Date("2025-03-12"),nr:"AN-24091",status:"Akzeptiert",name:"Badsanierung",erstelltVon:"CM",leistungen:[{typ:"Dienstleistung",titel:"Demontage & Entsorgung",menge:18,einheit:"Std",einzelpreis:78},{typ:"Dienstleistung",titel:"Fliesenarbeiten Nassbereich",menge:32,einheit:"Std",einzelpreis:82},{typ:"Ersatzteil",titel:"Sanit\xE4rpaket Komfort",menge:1,einheit:"Pauschal",einzelpreis:4300},{typ:"Ersatzteil",titel:"Duschabtrennung Glas",menge:1,einheit:"Stk",einzelpreis:1280}],betragNetto:9608}],rechnungen:[{datum:new Date("2025-03-30"),nr:"RE-24105",status:"Teilgezahlt",leistungen:[{typ:"Dienstleistung",titel:"Abschlagszahlung Rohinstallation",menge:20,einheit:"Std",einzelpreis:85},{typ:"Ersatzteil",titel:"Teilrechnung Sanit\xE4rmaterial",menge:1,einheit:"Pauschal",einzelpreis:3600},{typ:"Ersatzteil",titel:"Teilrechnung Fliesen",menge:1,einheit:"Pauschal",einzelpreis:820}],betragNetto:6120,betragBrutto:7282.8,faelligAm:new Date("2025-04-29")}]},{name:"Leitungssanierung Einfamilienhaus Grunewald",nr:"24-PL-099",status:"Abgeschlossen",ausfuehrungsort:"Grunewaldstra\xDFe 5, 14193 Berlin",kunde:"Familie Schulz",letzteAenderung:new Date("2025-12-22"),beschreibung:"Austausch der kompletten Frisch- und Abwasserleitungen inkl. Warmwasserbereitung.",umsatz:28460,ausgaben:19840,offenerBetrag:0,termine:[{datum:new Date("2025-02-01"),vonBis:"Ganzt\xE4gig",status:"Erledigt",name:"Abnahme Leitungsnetz",mitarbeiter:"MS"}],angebote:[{datum:new Date("2024-11-10"),nr:"AN-23990",status:"Akzeptiert",name:"Komplettpaket Leitungssanierung",erstelltVon:"MS",leistungen:[{typ:"Dienstleistung",titel:"Projektleitung Sanit\xE4r",menge:96,einheit:"Std",einzelpreis:88},{typ:"Dienstleistung",titel:"Installation Warmwasser",menge:128,einheit:"Std",einzelpreis:86},{typ:"Ersatzteil",titel:"Rohrmaterial & D\xE4mmung",menge:1,einheit:"Pauschal",einzelpreis:6840},{typ:"Ersatzteil",titel:"Warmwasserspeicher 300l",menge:1,einheit:"Stk",einzelpreis:2164}],betragNetto:28460}],rechnungen:[{datum:new Date("2025-02-10"),nr:"RE-23901",status:"Bezahlt",leistungen:[{typ:"Dienstleistung",titel:"Projektleitung & Koordination",menge:96,einheit:"Std",einzelpreis:88},{typ:"Dienstleistung",titel:"Installation Warmwasserstation",menge:128,einheit:"Std",einzelpreis:86},{typ:"Ersatzteil",titel:"Materialpaket Leitungen",menge:1,einheit:"Pauschal",einzelpreis:6840},{typ:"Ersatzteil",titel:"Warmwasserspeicher 300l",menge:1,einheit:"Stk",einzelpreis:2164}],betragNetto:28460,betragBrutto:33867.4,faelligAm:new Date("2025-02-24")}]}];this.commit(e)}createLeistungskatalog(t=!1){if(!t&&this._leistungskatalog().length)return;let e=new Date,n=[{id:"LK-001",nummer:"LK-001",titel:"Aufma\xDF & Planung Sanit\xE4ranlagen",beschreibung:"Bestandsaufnahme, Leitungsplanung und Angebotserstellung f\xFCr Sanit\xE4rarbeiten",typ:"Dienstleistung",menge:1,einheit:"Std",einzelpreis:78,katalogId:"LK-001",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-10)},{id:"LK-002",nummer:"LK-002",titel:"Montage Brennwerttherme",beschreibung:"Einbau, Anschluss und Inbetriebnahme einer Brennwerttherme inklusive Abgassystem",typ:"Dienstleistung",menge:1,einheit:"Std",einzelpreis:96,katalogId:"LK-002",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-8)},{id:"LK-003",nummer:"LK-003",titel:"Sanit\xE4rpaket Komplettbad",beschreibung:"Armaturen, Keramik und Rohrmaterial f\xFCr eine vollst\xE4ndige Badsanierung",typ:"Ersatzteil",menge:1,einheit:"Pauschal",einzelpreis:3250,katalogId:"LK-003",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-6)},{id:"LK-004",nummer:"LK-004",titel:"Verlegung Trinkwasserleitungen",beschreibung:"Neuinstallation von Warm- und Kaltwasserleitungen inklusive D\xE4mmung",typ:"Dienstleistung",menge:1,einheit:"Std",einzelpreis:84,katalogId:"LK-004",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-4)},{id:"LK-005",nummer:"LK-005",titel:"Dichtheitspr\xFCfung Abwasser",beschreibung:"Pr\xFCfung des Abwassersystems mit Protokoll gem\xE4\xDF DIN EN 1610",typ:"Dienstleistung",menge:1,einheit:"Std",einzelpreis:88,katalogId:"LK-005",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-2)},{id:"LK-006",nummer:"LK-006",titel:"Materialpaket Heizkreisverteiler",beschreibung:"Verteiler, Ventile und Zubeh\xF6r f\xFCr einen kompletten Heizkreis",typ:"Ersatzteil",menge:1,einheit:"Pauschal",einzelpreis:1860,katalogId:"LK-006",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-1)}];this._leistungskatalog.set(n),this.saveLeistungen()}getProjekte(){return this._projekte()}findByNr(t){return this._projekte().find(e=>e.nr===t)}updateProject(t,e){let n=this._projekte().map(i=>i.nr!==t?i:l(r(r({},i),e),{letzteAenderung:new Date}));this.commit(n)}addTermin(t,e){let n=this._projekte().map(i=>{if(i.nr!==t)return i;let s=l(r({},e),{datum:this.ensureDate(e.datum)??new Date(e.datum??new Date)}),u=[...i.termine??[],s];return l(r({},i),{termine:u,letzteAenderung:new Date})});this.commit(n)}addAngebot(t,e){let n=this._projekte().map(i=>{if(i.nr!==t)return i;let s=(e.leistungen??[]).map(h=>r({},h)),u=l(r({},e),{datum:this.ensureDate(e.datum)??new Date,leistungen:s,betragNetto:e.betragNetto??this.sumLeistungen(s)}),m=[...i.angebote??[],u];return l(r({},i),{angebote:m,letzteAenderung:new Date})});this.commit(n)}updateAngebot(t,e,n){let i=this._projekte().map(s=>{if(s.nr!==t)return s;let u=[...s.angebote??[]],m=u[e];if(!m)return s;let h=(n.leistungen??[]).map(o=>l(r({},o),{menge:Number(o.menge)||0,einzelpreis:Number(o.einzelpreis)||0})),a=n.datum instanceof Date?n.datum:new Date(n.datum),g=l(r(r({},m),n),{datum:a,leistungen:h,betragNetto:n.betragNetto??this.sumLeistungen(h)});return u[e]=g,l(r({},s),{angebote:u,letzteAenderung:new Date})});this.commit(i)}addRechnung(t,e,n=!0){let i=this._projekte().map(s=>{if(s.nr!==t)return s;let u=(e.leistungen??[]).map(a=>r({},a)),m=l(r({},e),{datum:this.ensureDate(e.datum)??new Date,faelligAm:this.ensureDate(e.faelligAm),leistungen:u,betragNetto:e.betragNetto??this.sumLeistungen(u)}),h=[...s.rechnungen??[],m];return l(r({},s),{rechnungen:h,letzteAenderung:new Date})});this.commit(i)}updateRechnung(t,e,n,i=!0){let s=this._projekte().map(u=>{if(u.nr!==t)return u;let m=[...u.rechnungen??[]],h=m[e];if(!h)return u;let a=(n.leistungen??[]).map(p=>l(r({},p),{menge:Number(p.menge)||0,einzelpreis:Number(p.einzelpreis)||0})),g=n.datum instanceof Date?n.datum:new Date(n.datum),o=n.faelligAm?n.faelligAm instanceof Date?n.faelligAm:new Date(n.faelligAm):void 0,c=n.betragNetto??this.sumLeistungen(a),z=l(r(r({},h),n),{datum:g,faelligAm:o,leistungen:a,betragNetto:c});return m[e]=z,l(r({},u),{rechnungen:m,letzteAenderung:new Date})});this.commit(s)}commit(t){let e=t.map(n=>this.recalculateProject(n));this._projekte.set(e),this.saveProjects()}createLeistungId(){let t=this._leistungskatalog(),e=t.length+1,n="";do n=`LK-${e.toString().padStart(3,"0")}`,e++;while(t.some(i=>i.id===n));return n}saveProjects(){try{localStorage.setItem(this.STORAGE_KEY_PROJEKTE,JSON.stringify(this._projekte()))}catch{}}saveLeistungen(){try{let t=this._leistungskatalog().map(e=>l(r({},e),{zuletztAktualisiert:e.zuletztAktualisiert.toISOString()}));localStorage.setItem(this.STORAGE_KEY_LEISTUNGEN,JSON.stringify(t))}catch{}}loadProjects(){try{let t=localStorage.getItem(this.STORAGE_KEY_PROJEKTE);return t?JSON.parse(t).map(n=>this.recalculateProject(n)):null}catch{return null}}loadLeistungen(){try{let t=localStorage.getItem(this.STORAGE_KEY_LEISTUNGEN);return t?JSON.parse(t).map(n=>l(r({},n),{zuletztAktualisiert:new Date(n.zuletztAktualisiert)})):null}catch{return null}}};d.\u0275fac=function(e){return new(e||d)},d.\u0275prov=f({token:d,factory:d.\u0275fac,providedIn:"root"});let b=d;return b})();export{N as a};
