import{a as k,d as f}from"./chunk-6T7TN4AG.js";import{a,b as l}from"./chunk-JHI3MBHO.js";var y=(()=>{let d=class d{sumLeistungen(n=[]){return n.reduce((e,t)=>{let i=Number(t.menge)||0,s=Number(t.einzelpreis)||0;return e+i*s},0)}sumMaterial(n=[]){return n.reduce((e,t)=>{let i=Number(t.menge)||0,s=Number(t.einzelpreis)||0,u=(t.typ??"").toLowerCase();return u==="ersatzteil"||u==="material"?e+i*s:e},0)}ensureDate(n){if(!n)return;let e=n instanceof Date?n:new Date(n);return Number.isNaN(e.getTime())?void 0:e}round(n){return Math.round((n+Number.EPSILON)*100)/100}normalizeLeistungen(n){return(n??[]).map(e=>l(a({},e),{menge:Number(e.menge)||0,einzelpreis:Number(e.einzelpreis)||0}))}calcBruttoFromNetto(n){let e=Number(n??0);return e?this.round(e*(1+this.VAT_RATE)):0}recalculateProject(n){let e=this.ensureDate(n.letzteAenderung)??new Date,t=(n.termine??[]).map(r=>l(a({},r),{datum:this.ensureDate(r.datum)??new Date(r.datum??new Date)})),i=(n.angebote??[]).map(r=>{let g=this.normalizeLeistungen(r.leistungen),o=this.ensureDate(r.datum)??new Date,c=r.betragNetto??this.sumLeistungen(g);return l(a({},r),{datum:o,leistungen:g,betragNetto:this.round(c)})}),s=(n.rechnungen??[]).map(r=>{let g=this.normalizeLeistungen(r.leistungen),o=this.ensureDate(r.datum)??new Date,c=this.ensureDate(r.faelligAm),z=r.betragNetto??this.sumLeistungen(g),p=r.betragBrutto??this.calcBruttoFromNetto(z);return l(a({},r),{datum:o,faelligAm:c,leistungen:g,betragNetto:this.round(z),betragBrutto:this.round(p)})}),u=this.round(s.reduce((r,g)=>{let o=(g.status??"").trim().toLowerCase();return o.includes("bezahlt")&&!o.includes("teil")?r+(g.betragNetto??0):r},0)),m=this.round(s.reduce((r,g)=>r+this.sumMaterial(g.leistungen??[]),0)),h=this.round(s.reduce((r,g)=>{let o=(g.status??"").toLowerCase();return o.includes("bezahlt")||o.includes("storniert")?r:r+(g.betragBrutto??g.betragNetto??0)},0));return l(a({},n),{letzteAenderung:e,termine:t,angebote:i,rechnungen:s,umsatz:u,ausgaben:m,offenerBetrag:h})}getLeistungskatalog(){return this._leistungskatalog()}findLeistungById(n){return this._leistungskatalog().find(e=>e.id===n)}addLeistungskatalogEintrag(n){let e=this.createLeistungId(),t=n.nummer?.trim()||e,i={id:e,nummer:t,titel:n.titel?.trim()||"Neue Leistung",beschreibung:n.beschreibung?.trim()||void 0,typ:n.typ,menge:Number(n.menge??1)||1,einheit:n.einheit?.trim()||"Einheit",einzelpreis:Number(n.einzelpreis)||0,katalogId:e,zuletztAktualisiert:new Date},s=[...this._leistungskatalog(),i];return this._leistungskatalog.set(s),this.saveLeistungen(),i}constructor(){this.STORAGE_KEY_PROJEKTE="dummy.projects.v1",this.STORAGE_KEY_LEISTUNGEN="dummy.services.v1",this.VAT_RATE=.19,this._projekte=f(this.loadProjects()??[]),this._leistungskatalog=f(this.loadLeistungen()??[]),this.projektesig=this._projekte.asReadonly(),this.leistungskatalogsig=this._leistungskatalog.asReadonly(),this.createProjects(),this.createLeistungskatalog()}createProjects(n=!1){if(!n&&this._projekte().length)return;let e=new Date,t=s=>{let u=new Date(e);return u.setDate(u.getDate()+s),u},i=[{name:"Badsanierung Altbau Friedrichshain",nr:"24-PL-011",status:"Abgeschlossen",ausfuehrungsort:"M\xFCggelstra\xDFe 18, 10247 Berlin",kunde:"Frank K\xF6hler",letzteAenderung:t(-5),beschreibung:"Komplette Badsanierung inkl. neuer Rohrf\xFChrung, Sanit\xE4rkeramik und Armaturen.",umsatz:7704,ausgaben:4980,offenerBetrag:0,termine:[{datum:t(-35),vonBis:"08:00 - 16:30",status:"Erledigt",name:"Endabnahme Sanit\xE4r",mitarbeiter:"CM"}],angebote:[{datum:t(-60),nr:"AN-24028",status:"Akzeptiert",name:"Bad Komplettangebot",erstelltVon:"CM",leistungen:[{typ:"Dienstleistung",titel:"Aufma\xDF und Planung Sanit\xE4r",beschreibung:"Vorbereitung der Leitungsf\xFChrung",menge:12,einheit:"Std",einzelpreis:78},{typ:"Dienstleistung",titel:"Montage Sanit\xE4rkeramik",beschreibung:"Installation WC, Waschtisch und Dusche",menge:26,einheit:"Std",einzelpreis:84},{typ:"Ersatzteil",titel:"Rohrmaterial Kupfer & Fittings",menge:1,einheit:"Pauschal",einzelpreis:1200},{typ:"Ersatzteil",titel:"Sanit\xE4rausstattung Komfort",menge:1,einheit:"Pauschal",einzelpreis:2950}],betragNetto:7270}],rechnungen:[{datum:t(-25),nr:"RE-24089",status:"Bezahlt",leistungen:[{typ:"Dienstleistung",titel:"Demontage Altinstallation",menge:14,einheit:"Std",einzelpreis:78},{typ:"Dienstleistung",titel:"Neuinstallation Sanit\xE4rleitungen",menge:28,einheit:"Std",einzelpreis:84},{typ:"Ersatzteil",titel:"Rohrmaterial Kupfer",menge:1,einheit:"Pauschal",einzelpreis:1280},{typ:"Ersatzteil",titel:"Badm\xF6bel & Armaturen",menge:1,einheit:"Pauschal",einzelpreis:2980}],betragNetto:7704,betragBrutto:9166.76,faelligAm:t(-11)}]},{name:"Heizungsmodernisierung Prenzlauer Berg",nr:"24-PL-024",status:"In Arbeit",ausfuehrungsort:"Sch\xF6nhauser Allee 87, 10439 Berlin",kunde:"Sabine Hoffmann",letzteAenderung:t(-1),beschreibung:"Umr\xFCstung der Heizungsanlage auf eine effiziente Brennwerttherme inkl. Heizkreisverteiler.",umsatz:5818,ausgaben:7390,offenerBetrag:6934.42,termine:[{datum:t(3),vonBis:"12:30 - 17:00",status:"Best\xE4tigt",name:"Hydraulischer Abgleich",mitarbeiter:"LZ"}],angebote:[{datum:t(-20),nr:"AN-24052",status:"Akzeptiert",name:"Modernisierung Heizungsanlage",erstelltVon:"LZ",leistungen:[{typ:"Dienstleistung",titel:"Demontage Altanlage",beschreibung:"Abbau bestehender Kesselanlage",menge:18,einheit:"Std",einzelpreis:82},{typ:"Dienstleistung",titel:"Montage Brennwerttherme",beschreibung:"Installation inkl. Abgassystem",menge:32,einheit:"Std",einzelpreis:96},{typ:"Ersatzteil",titel:"Brennwerttherme Komplettset",menge:1,einheit:"Stk",einzelpreis:7400},{typ:"Ersatzteil",titel:"Heizkreisverteiler 6-fach",menge:1,einheit:"Stk",einzelpreis:1850}],betragNetto:13798}],rechnungen:[{datum:t(-7),nr:"RE-24073",status:"Offen",leistungen:[{typ:"Dienstleistung",titel:"Rohinstallation Heizkreis",menge:26,einheit:"Std",einzelpreis:94},{typ:"Dienstleistung",titel:"Inbetriebnahme Heizung",menge:12,einheit:"Std",einzelpreis:102},{typ:"Ersatzteil",titel:"Pufferspeicher 200l",menge:1,einheit:"Stk",einzelpreis:2150}],betragNetto:5818,betragBrutto:6934.42,faelligAm:t(21)}]},{name:"W\xE4rmepumpeninstallation Kreuzberg",nr:"24-PL-037",status:"Geplant",ausfuehrungsort:"Gneisenaustra\xDFe 42, 10961 Berlin",kunde:"Bau GmbH M\xFCller",letzteAenderung:t(-2),beschreibung:"Planung und Installation einer Luft-Wasser-W\xE4rmepumpe mit Speicher.",umsatz:0,ausgaben:0,offenerBetrag:11885.24,termine:[{datum:t(10),vonBis:"09:00 - 11:00",status:"Geplant",name:"Technische Abstimmung",mitarbeiter:"AN"}],angebote:[{datum:t(-3),nr:"AN-24088",status:"Versendet",name:"W\xE4rmepumpen-Komplettpaket",erstelltVon:"AN",leistungen:[{typ:"Dienstleistung",titel:"Demontage Altanlage",menge:16,einheit:"Std",einzelpreis:82},{typ:"Dienstleistung",titel:"Installation W\xE4rmepumpe",menge:24,einheit:"Std",einzelpreis:96},{typ:"Ersatzteil",titel:"W\xE4rmepumpenset 12 kW",menge:1,einheit:"Stk",einzelpreis:5200},{typ:"Ersatzteil",titel:"Hydraulikmodul & Speicher",menge:1,einheit:"Pauschal",einzelpreis:1180}],betragNetto:9996}],rechnungen:[]},{name:"Badsanierung Mitte",nr:"24-PL-058",status:"In Arbeit",ausfuehrungsort:"Torstra\xDFe 78, 10119 Berlin",kunde:"Lars Neumann",letzteAenderung:t(-3),beschreibung:"Komplettsanierung eines Badezimmers inkl. bodengleicher Dusche.",umsatz:6120,ausgaben:5280,offenerBetrag:7282.8,termine:[{datum:t(4),vonBis:"08:00 - 16:00",status:"Geplant",name:"Demontage Altbad",mitarbeiter:"CM"}],angebote:[{datum:t(-18),nr:"AN-24091",status:"Akzeptiert",name:"Badsanierung",erstelltVon:"CM",leistungen:[{typ:"Dienstleistung",titel:"Demontage & Entsorgung",menge:18,einheit:"Std",einzelpreis:78},{typ:"Dienstleistung",titel:"Fliesenarbeiten Nassbereich",menge:32,einheit:"Std",einzelpreis:82},{typ:"Ersatzteil",titel:"Sanit\xE4rpaket Komfort",menge:1,einheit:"Pauschal",einzelpreis:4300},{typ:"Ersatzteil",titel:"Duschabtrennung Glas",menge:1,einheit:"Stk",einzelpreis:1280}],betragNetto:9608}],rechnungen:[{datum:t(-5),nr:"RE-24105",status:"Teilgezahlt",leistungen:[{typ:"Dienstleistung",titel:"Abschlagszahlung Rohinstallation",menge:20,einheit:"Std",einzelpreis:85},{typ:"Ersatzteil",titel:"Teilrechnung Sanit\xE4rmaterial",menge:1,einheit:"Pauschal",einzelpreis:3600},{typ:"Ersatzteil",titel:"Teilrechnung Fliesen",menge:1,einheit:"Pauschal",einzelpreis:820}],betragNetto:6120,betragBrutto:7282.8,faelligAm:t(23)}]},{name:"Leitungssanierung Einfamilienhaus Grunewald",nr:"24-PL-099",status:"Abgeschlossen",ausfuehrungsort:"Grunewaldstra\xDFe 5, 14193 Berlin",kunde:"Familie Schulz",letzteAenderung:t(-40),beschreibung:"Austausch der kompletten Frisch- und Abwasserleitungen inkl. Warmwasserbereitung.",umsatz:28460,ausgaben:19840,offenerBetrag:0,termine:[{datum:t(-70),vonBis:"Ganzt\xE4gig",status:"Erledigt",name:"Abnahme Leitungsnetz",mitarbeiter:"MS"}],angebote:[{datum:t(-120),nr:"AN-23990",status:"Akzeptiert",name:"Komplettpaket Leitungssanierung",erstelltVon:"MS",leistungen:[{typ:"Dienstleistung",titel:"Projektleitung Sanit\xE4r",menge:96,einheit:"Std",einzelpreis:88},{typ:"Dienstleistung",titel:"Installation Warmwasser",menge:128,einheit:"Std",einzelpreis:86},{typ:"Ersatzteil",titel:"Rohrmaterial & D\xE4mmung",menge:1,einheit:"Pauschal",einzelpreis:6840},{typ:"Ersatzteil",titel:"Warmwasserspeicher 300l",menge:1,einheit:"Stk",einzelpreis:2164}],betragNetto:28460}],rechnungen:[{datum:t(-60),nr:"RE-23901",status:"Bezahlt",leistungen:[{typ:"Dienstleistung",titel:"Projektleitung & Koordination",menge:96,einheit:"Std",einzelpreis:88},{typ:"Dienstleistung",titel:"Installation Warmwasserstation",menge:128,einheit:"Std",einzelpreis:86},{typ:"Ersatzteil",titel:"Materialpaket Leitungen",menge:1,einheit:"Pauschal",einzelpreis:6840},{typ:"Ersatzteil",titel:"Warmwasserspeicher 300l",menge:1,einheit:"Stk",einzelpreis:2164}],betragNetto:28460,betragBrutto:33867.4,faelligAm:t(-46)}]}];this.commit(i)}createLeistungskatalog(n=!1){if(!n&&this._leistungskatalog().length)return;let e=new Date,t=[{id:"LK-001",nummer:"LK-001",titel:"Aufma\xDF & Planung Sanit\xE4ranlagen",beschreibung:"Bestandsaufnahme, Leitungsplanung und Angebotserstellung f\xFCr Sanit\xE4rarbeiten",typ:"Dienstleistung",menge:1,einheit:"Std",einzelpreis:78,katalogId:"LK-001",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-10)},{id:"LK-002",nummer:"LK-002",titel:"Montage Brennwerttherme",beschreibung:"Einbau, Anschluss und Inbetriebnahme einer Brennwerttherme inklusive Abgassystem",typ:"Dienstleistung",menge:1,einheit:"Std",einzelpreis:96,katalogId:"LK-002",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-8)},{id:"LK-003",nummer:"LK-003",titel:"Sanit\xE4rpaket Komplettbad",beschreibung:"Armaturen, Keramik und Rohrmaterial f\xFCr eine vollst\xE4ndige Badsanierung",typ:"Ersatzteil",menge:1,einheit:"Pauschal",einzelpreis:3250,katalogId:"LK-003",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-6)},{id:"LK-004",nummer:"LK-004",titel:"Verlegung Trinkwasserleitungen",beschreibung:"Neuinstallation von Warm- und Kaltwasserleitungen inklusive D\xE4mmung",typ:"Dienstleistung",menge:1,einheit:"Std",einzelpreis:84,katalogId:"LK-004",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-4)},{id:"LK-005",nummer:"LK-005",titel:"Dichtheitspr\xFCfung Abwasser",beschreibung:"Pr\xFCfung des Abwassersystems mit Protokoll gem\xE4\xDF DIN EN 1610",typ:"Dienstleistung",menge:1,einheit:"Std",einzelpreis:88,katalogId:"LK-005",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-2)},{id:"LK-006",nummer:"LK-006",titel:"Materialpaket Heizkreisverteiler",beschreibung:"Verteiler, Ventile und Zubeh\xF6r f\xFCr einen kompletten Heizkreis",typ:"Ersatzteil",menge:1,einheit:"Pauschal",einzelpreis:1860,katalogId:"LK-006",zuletztAktualisiert:new Date(e.getFullYear(),e.getMonth(),e.getDate()-1)}];this._leistungskatalog.set(t),this.saveLeistungen()}getProjekte(){return this._projekte()}findByNr(n){return this._projekte().find(e=>e.nr===n)}updateProject(n,e){let t=this._projekte().map(i=>i.nr!==n?i:l(a(a({},i),e),{letzteAenderung:new Date}));this.commit(t)}addTermin(n,e){let t=this._projekte().map(i=>{if(i.nr!==n)return i;let s=l(a({},e),{datum:this.ensureDate(e.datum)??new Date(e.datum??new Date)}),u=[...i.termine??[],s];return l(a({},i),{termine:u,letzteAenderung:new Date})});this.commit(t)}addAngebot(n,e){let t=this._projekte().map(i=>{if(i.nr!==n)return i;let s=(e.leistungen??[]).map(h=>a({},h)),u=l(a({},e),{datum:this.ensureDate(e.datum)??new Date,leistungen:s,betragNetto:e.betragNetto??this.sumLeistungen(s)}),m=[...i.angebote??[],u];return l(a({},i),{angebote:m,letzteAenderung:new Date})});this.commit(t)}updateAngebot(n,e,t){let i=this._projekte().map(s=>{if(s.nr!==n)return s;let u=[...s.angebote??[]],m=u[e];if(!m)return s;let h=(t.leistungen??[]).map(o=>l(a({},o),{menge:Number(o.menge)||0,einzelpreis:Number(o.einzelpreis)||0})),r=t.datum instanceof Date?t.datum:new Date(t.datum),g=l(a(a({},m),t),{datum:r,leistungen:h,betragNetto:t.betragNetto??this.sumLeistungen(h)});return u[e]=g,l(a({},s),{angebote:u,letzteAenderung:new Date})});this.commit(i)}addRechnung(n,e,t=!0){let i=this._projekte().map(s=>{if(s.nr!==n)return s;let u=(e.leistungen??[]).map(r=>a({},r)),m=l(a({},e),{datum:this.ensureDate(e.datum)??new Date,faelligAm:this.ensureDate(e.faelligAm),leistungen:u,betragNetto:e.betragNetto??this.sumLeistungen(u)}),h=[...s.rechnungen??[],m];return l(a({},s),{rechnungen:h,letzteAenderung:new Date})});this.commit(i)}updateRechnung(n,e,t,i=!0){let s=this._projekte().map(u=>{if(u.nr!==n)return u;let m=[...u.rechnungen??[]],h=m[e];if(!h)return u;let r=(t.leistungen??[]).map(p=>l(a({},p),{menge:Number(p.menge)||0,einzelpreis:Number(p.einzelpreis)||0})),g=t.datum instanceof Date?t.datum:new Date(t.datum),o=t.faelligAm?t.faelligAm instanceof Date?t.faelligAm:new Date(t.faelligAm):void 0,c=t.betragNetto??this.sumLeistungen(r),z=l(a(a({},h),t),{datum:g,faelligAm:o,leistungen:r,betragNetto:c});return m[e]=z,l(a({},u),{rechnungen:m,letzteAenderung:new Date})});this.commit(s)}commit(n){let e=n.map(t=>this.recalculateProject(t));this._projekte.set(e),this.saveProjects()}createLeistungId(){let n=this._leistungskatalog(),e=n.length+1,t="";do t=`LK-${e.toString().padStart(3,"0")}`,e++;while(n.some(i=>i.id===t));return t}saveProjects(){try{localStorage.setItem(this.STORAGE_KEY_PROJEKTE,JSON.stringify(this._projekte()))}catch{}}saveLeistungen(){try{let n=this._leistungskatalog().map(e=>l(a({},e),{zuletztAktualisiert:e.zuletztAktualisiert.toISOString()}));localStorage.setItem(this.STORAGE_KEY_LEISTUNGEN,JSON.stringify(n))}catch{}}loadProjects(){try{let n=localStorage.getItem(this.STORAGE_KEY_PROJEKTE);return n?JSON.parse(n).map(t=>this.recalculateProject(t)):null}catch{return null}}loadLeistungen(){try{let n=localStorage.getItem(this.STORAGE_KEY_LEISTUNGEN);return n?JSON.parse(n).map(t=>l(a({},t),{zuletztAktualisiert:new Date(t.zuletztAktualisiert)})):null}catch{return null}}};d.\u0275fac=function(e){return new(e||d)},d.\u0275prov=k({token:d,factory:d.\u0275fac,providedIn:"root"});let b=d;return b})();export{y as a};
