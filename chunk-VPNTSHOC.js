import{a as ge}from"./chunk-DWTWEUSI.js";import{Ba as oe,Ca as re,D as S,Da as ae,Ea as le,F as E,G as z,Ga as se,H as D,I as L,Ia as ue,J as B,K as F,Ka as ce,La as me,M as j,N as A,P as $,R as U,b as p,ba as K,c as d,ca as G,d as V,e as c,f as P,g as N,h,ha as H,i as g,ia as Z,j as o,k as r,l as I,m as O,n as R,o as f,p as x,pa as q,q as s,qa as J,r as M,ra as Q,s as m,sa as W,t as C,ta as X,u as k,ua as Y,v as T,va as ee,wa as te,ya as ne,za as ie}from"./chunk-6T7TN4AG.js";import"./chunk-W6H37XDB.js";import"./chunk-7KGURMOZ.js";import"./chunk-YK4DTNHI.js";import"./chunk-YK3APVNZ.js";import"./chunk-366LSZGT.js";import"./chunk-JVTPOORY.js";import"./chunk-CLDSZD2A.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-DVVH2KKN.js";import"./chunk-NV3QH4JK.js";import"./chunk-4YRHGV2P.js";import"./chunk-OZYWYLNK.js";import"./chunk-42C7ZIID.js";import{a as b,b as v}from"./chunk-JHI3MBHO.js";function _e(l,_){if(l&1){let i=f();o(0,"ion-button",28),x("click",function(){p(i);let t=s(2);return d(t.openProjekt())}),m(1),r()}if(l&2){let i,e=s(2);c(),k(" Zum Projekt ",(i=e.projekt())==null?null:i.nr," ")}}function pe(l,_){if(l&1){let i=f();o(0,"ion-datetime",29),x("ionChange",function(t){p(i);let n=s(2);return d(n.updateField("datum",n.asString(t.detail.value)))}),r()}if(l&2){let i,e=s(2);g("value",(i=e.form())==null?null:i.datum)}}function de(l,_){if(l&1&&(o(0,"ion-select-option",30),m(1),r()),l&2){let i=_.$implicit;g("value",i),c(),C(i)}}function xe(l,_){if(l&1){let i=f();o(0,"ion-datetime",31),x("ionChange",function(t){p(i);let n=s(2);return d(n.updateField("faelligAm",n.asString(t.detail.value)))}),r()}if(l&2){let i,e=s(2);g("value",(i=e.form())==null?null:i.faelligAm)}}function he(l,_){if(l&1&&(o(0,"ion-select-option",30),m(1),S(2,"currency"),r()),l&2){let i=_.$implicit;g("value",i.id),c(),T(" ",i.titel," \xB7 ",E(2,3,i.einzelpreis,"EUR","symbol","1.0-0")," ")}}function fe(l,_){if(l&1&&(o(0,"div",47),m(1),r()),l&2){let i=s(3).$implicit;c(),C(i.beschreibung)}}function be(l,_){if(l&1&&(o(0,"div",43)(1,"div",44),m(2),r(),o(3,"div",45),m(4),S(5,"currency"),r(),h(6,fe,2,1,"div",46),r()),l&2){let i=s(2).$implicit;c(2),C(i.titel),c(2),T("",i.einheit," \xB7 ",E(5,4,i.einzelpreis,"EUR","symbol","1.2-2")),c(2),g("ngIf",i.beschreibung)}}function ve(l,_){if(l&1){let i=f();O(0),o(1,"ion-item",37)(2,"ion-label",13),m(3,"Aus Katalog \xFCbernehmen"),r(),o(4,"ion-select",38),x("ionChange",function(t){p(i);let n=s().index,a=s(2);return d(a.selectFromCatalog(n,a.asCatalogId(t.detail.value)))}),o(5,"ion-select-option",39),m(6,"Keine Auswahl"),r(),h(7,he,3,8,"ion-select-option",18),r()(),h(8,be,7,9,"div",40),o(9,"ion-item",37)(10,"ion-label",13),m(11,"Menge"),r(),o(12,"ion-input",41),x("ionInput",function(t){p(i);let n=s().index,a=s(2);return d(a.updateLeistung(n,{menge:a.asNumber(t.detail.value)}))}),r()(),o(13,"ion-button",42),x("click",function(){p(i);let t=s().index,n=s(2);return d(n.useManualEntry(t))}),m(14," Eigene Leistung erfassen "),r(),R()}if(l&2){let i=s().$implicit,e=s(2);c(4),g("value",i.katalogId??""),c(3),g("ngForOf",e.katalog()),c(),g("ngIf",i.katalogId),c(4),g("value",i.menge)}}function Ce(l,_){if(l&1&&(o(0,"ion-select-option",30),m(1),r()),l&2){let i=_.$implicit;g("value",i),c(),C(i)}}function ye(l,_){if(l&1){let i=f();o(0,"ion-grid",48)(1,"ion-row")(2,"ion-col",49)(3,"ion-item",37)(4,"ion-label",13),m(5,"Art"),r(),o(6,"ion-select",17),x("ionChange",function(t){p(i);let n=s().index,a=s(2);return d(a.updateLeistung(n,{typ:a.asLeistungsart(t.detail.value)}))}),h(7,Ce,2,2,"ion-select-option",18),r()()(),o(8,"ion-col",50)(9,"ion-item",37)(10,"ion-label",13),m(11,"Titel"),r(),o(12,"ion-input",51),x("ionInput",function(t){p(i);let n=s().index,a=s(2);return d(a.updateLeistung(n,{titel:a.asString(t.detail.value)}))}),r()()()(),o(13,"ion-row")(14,"ion-col",52)(15,"ion-item",37)(16,"ion-label",13),m(17,"Beschreibung"),r(),o(18,"ion-textarea",53),x("ionInput",function(t){p(i);let n=s().index,a=s(2);return d(a.updateLeistung(n,{beschreibung:a.asString(t.detail.value)}))}),r()()()(),o(19,"ion-row")(20,"ion-col",49)(21,"ion-item",37)(22,"ion-label",13),m(23,"Menge"),r(),o(24,"ion-input",41),x("ionInput",function(t){p(i);let n=s().index,a=s(2);return d(a.updateLeistung(n,{menge:a.asNumber(t.detail.value)}))}),r()()(),o(25,"ion-col",49)(26,"ion-item",37)(27,"ion-label",13),m(28,"Einheit"),r(),o(29,"ion-input",54),x("ionInput",function(t){p(i);let n=s().index,a=s(2);return d(a.updateLeistung(n,{einheit:a.asString(t.detail.value)}))}),r()()(),o(30,"ion-col",49)(31,"ion-item",37)(32,"ion-label",13),m(33,"Einzelpreis (netto)"),r(),o(34,"ion-input",41),x("ionInput",function(t){p(i);let n=s().index,a=s(2);return d(a.updateLeistung(n,{einzelpreis:a.asNumber(t.detail.value)}))}),r()()()()(),o(35,"ion-button",42),x("click",function(){p(i);let t=s().index,n=s(2);return d(n.useCatalogEntry(t))}),m(36," Aus Katalog w\xE4hlen "),r()}if(l&2){let i=s().$implicit,e=s(2);c(6),g("value",i.typ),c(),g("ngForOf",e.leistungstypen),c(5),g("value",i.titel),c(6),g("value",i.beschreibung),c(6),g("value",i.menge),c(5),g("value",i.einheit),c(5),g("value",i.einzelpreis)}}function Ie(l,_){if(l&1){let i=f();o(0,"div",32)(1,"div",33)(2,"div",34),m(3),r(),o(4,"ion-button",35),x("click",function(){let t=p(i).index,n=s(2);return d(n.removeLeistung(t))}),m(5," Entfernen "),r()(),h(6,ve,15,4,"ng-container",8)(7,ye,37,7,"ng-template",null,1,z),o(9,"div",36)(10,"span"),m(11,"Positionssumme"),r(),o(12,"span"),m(13),S(14,"currency"),r()()()}if(l&2){let i,e=_.$implicit,t=_.index,n=M(8),a=s(2);c(3),k("Position ",t+1),c(),g("disabled",(((i=a.form())==null||i.leistungen==null?null:i.leistungen.length)||0)<=1),c(2),g("ngIf",e.modus==="catalog")("ngIfElse",n),c(7),C(E(14,5,a.calcPositionSum(e),"EUR","symbol","1.2-2"))}}function Se(l,_){if(l&1){let i=f();O(0),o(1,"div",10),m(2),r(),h(3,_e,2,1,"ion-button",11),o(4,"ion-list",12)(5,"ion-item")(6,"ion-label",13),m(7,"Datum"),r(),I(8,"ion-datetime-button",14),o(9,"ion-modal",15),h(10,pe,1,1,"ng-template"),r()(),o(11,"ion-item")(12,"ion-label",13),m(13,"Nummer"),r(),o(14,"ion-input",16),x("ionInput",function(t){p(i);let n=s();return d(n.updateField("nr",n.asString(t.detail.value)))}),r()(),o(15,"ion-item")(16,"ion-label",13),m(17,"Status"),r(),o(18,"ion-select",17),x("ionChange",function(t){p(i);let n=s();return d(n.updateField("status",n.asStatus(t.detail.value)))}),h(19,de,2,2,"ion-select-option",18),r()(),o(20,"ion-item",19)(21,"ion-label",13),m(22,"F\xE4llig am"),r(),I(23,"ion-datetime-button",20),o(24,"ion-modal",15),h(25,xe,1,1,"ng-template"),r()(),o(26,"ion-item")(27,"ion-label",13),m(28,"Betrag (brutto)"),r(),o(29,"ion-input",21),x("ionInput",function(t){p(i);let n=s();return d(n.updateField("betragBrutto",n.asString(t.detail.value)))}),r()()(),o(30,"div",22)(31,"div",23),m(32,"Leistungen"),r(),o(33,"ion-button",24),x("click",function(){p(i);let t=s();return d(t.addLeistung())}),m(34," Position hinzuf\xFCgen "),r()(),o(35,"div",25),h(36,Ie,15,10,"div",26),r(),o(37,"ion-item",27)(38,"ion-label"),m(39,"Gesamtsumme (netto)"),r(),o(40,"ion-text",4),m(41),S(42,"currency"),r()(),R()}if(l&2){let i,e,t,n,a,u=s();c(2),k(" ",((i=u.form())==null?null:i.nr)||"Rechnung"," "),c(),g("ngIf",u.projekt()),c(6),g("keepContentsMounted",!0),c(5),g("value",(e=u.form())==null?null:e.nr),c(4),g("value",(t=u.form())==null?null:t.status),c(),g("ngForOf",u.statusOptions),c(5),g("keepContentsMounted",!0),c(5),g("value",(n=u.form())==null?null:n.betragBrutto),c(7),g("ngForOf",(a=u.form())==null?null:a.leistungen),c(5),C(E(42,10,u.leistungssumme(),"EUR","symbol","1.2-2"))}}function Ee(l,_){if(l&1){let i=f();o(0,"div",55)(1,"p"),m(2,"Diese Rechnung konnte nicht gefunden werden."),r(),o(3,"ion-button",56),x("click",function(){p(i);let t=s();return d(t.goBack())}),m(4,"Zur \xDCbersicht"),r()()}}var Me=(()=>{let _=class _{constructor(e,t,n){this.route=e,this.router=t,this.dummy=n,this.projekt=D(()=>{let u=this.projektNr;return u?this.dummy.projektesig().find(y=>y.nr===u)??null:null}),this.rechnung=D(()=>{let u=this.projekt();return u?(u.rechnungen??[])[this.rechnungIndex]??null:null}),this.form=V(null),this.toastOpen=V(!1),this.statusOptions=["Entwurf","Offen","Teilgezahlt","Bezahlt","\xDCberf\xE4llig","Storniert"],this.leistungstypen=["Dienstleistung","Ersatzteil"],this.katalog=this.dummy.leistungskatalogsig,this.leistungssumme=D(()=>{let u=this.form();return u?u.leistungen.reduce((y,w)=>y+(Number(w.menge)||0)*(Number(w.einzelpreis)||0),0):0}),this.dummy.createProjects(),this.projektNr=this.route.snapshot.paramMap.get("nr")??"";let a=this.route.snapshot.paramMap.get("rechnungIndex");this.rechnungIndex=a?Number(a):0,Number.isNaN(this.rechnungIndex)&&(this.rechnungIndex=0),L(()=>{let u=this.rechnung();if(!u){this.form.set(null);return}this.form.set(this.createFormState(u))})}createFormState(e){let t=(e.leistungen??[]).map(n=>({typ:n.typ??"Dienstleistung",titel:n.titel??"",beschreibung:n.beschreibung??"",menge:Number(n.menge)||0,einheit:n.einheit??"Std",einzelpreis:Number(n.einzelpreis)||0,katalogId:n.katalogId??null,modus:n.katalogId?"catalog":"manual"}));return{datum:e.datum?new Date(e.datum).toISOString():new Date().toISOString(),nr:e.nr??"R-0000",status:e.status??"Entwurf",faelligAm:e.faelligAm?new Date(e.faelligAm).toISOString():"",betragBrutto:e.betragBrutto!=null?String(e.betragBrutto):"",leistungen:t.length?t:[this.createEmptyLeistung()]}}createEmptyLeistung(){return{typ:"Dienstleistung",titel:"",beschreibung:"",menge:1,einheit:"Std",einzelpreis:0,katalogId:null,modus:"catalog"}}updateField(e,t){this.form.update(n=>n&&v(b({},n),{[e]:t}))}updateLeistung(e,t){this.form.update(n=>{if(!n)return n;let a=n.leistungen.map((u,y)=>{if(y!==e)return u;let w=typeof t=="function"?t(u):t;return b(b({},u),w)});return v(b({},n),{leistungen:a})})}addLeistung(){this.form.update(e=>e&&v(b({},e),{leistungen:[...e.leistungen,this.createEmptyLeistung()]}))}selectFromCatalog(e,t){this.updateLeistung(e,n=>{if(!t)return{katalogId:null,titel:"",beschreibung:"",menge:1,einheit:"Std",einzelpreis:0,modus:"catalog",typ:n.typ??this.leistungstypen[0]};let a=this.dummy.findLeistungById(t);return a?{katalogId:a.id,typ:a.typ,titel:a.titel,beschreibung:a.beschreibung??"",menge:a.menge??1,einheit:a.einheit,einzelpreis:a.einzelpreis,modus:"catalog"}:{katalogId:null,modus:"catalog"}})}useManualEntry(e){this.updateLeistung(e,t=>({modus:"manual",katalogId:null,typ:t.typ??this.leistungstypen[0],titel:"",beschreibung:"",menge:1,einheit:"Std",einzelpreis:0}))}useCatalogEntry(e){this.updateLeistung(e,t=>({modus:"catalog",katalogId:null,typ:t.typ??this.leistungstypen[0],titel:"",beschreibung:"",menge:1,einheit:"Std",einzelpreis:0}))}removeLeistung(e){this.form.update(t=>{if(!t)return t;let n=t.leistungen.filter((a,u)=>u!==e);return v(b({},t),{leistungen:n.length?n:[this.createEmptyLeistung()]})})}asString(e){return Array.isArray(e)?e[0]??"":e??""}asStatus(e){let t=this.asString(e);return this.statusOptions.includes(t)?t:this.statusOptions[0]}asLeistungsart(e){let t=this.asString(e);return this.leistungstypen.includes(t)?t:this.leistungstypen[0]}asCatalogId(e){let t=this.asString(e);return t||null}asNumber(e){Array.isArray(e)&&(e=e[0]);let t=typeof e=="number"?e:Number(e??0);return Number.isFinite(t)?t:0}calcPositionSum(e){let t=Number(e.menge)||0,n=Number(e.einzelpreis)||0;return t*n}openProjekt(){this.projektNr&&this.router.navigate(["/projekte",this.projektNr])}goBack(){this.router.navigate(["/rechnungen"])}save(){let e=this.form(),t=this.rechnung();if(!e||!t||!this.projektNr)return;let n=e.leistungen.map(u=>v(b({},u.modus==="catalog"&&u.katalogId?{katalogId:u.katalogId}:{}),{typ:u.typ,titel:u.titel?.trim()||"Leistung",beschreibung:u.beschreibung?.trim()||void 0,menge:Number(u.menge)||0,einheit:u.einheit?.trim()||"Einheit",einzelpreis:Number(u.einzelpreis)||0})),a=v(b({},t),{datum:e.datum?new Date(e.datum):new Date,nr:e.nr?.trim()||"R-0000",status:e.status?.trim()||"Entwurf",faelligAm:e.faelligAm?new Date(e.faelligAm):void 0,betragBrutto:e.betragBrutto?Number(e.betragBrutto):void 0,leistungen:n,betragNetto:this.leistungssumme()});this.dummy.updateRechnung(this.projektNr,this.rechnungIndex,a,!0),this.toastOpen.set(!0)}closeToast(){this.toastOpen.set(!1)}};_.\u0275fac=function(t){return new(t||_)(P($),P(U),P(ge))},_.\u0275cmp=N({type:_,selectors:[["app-rechnung-detail"]],decls:19,vars:4,consts:[["missing",""],["rechnungManualForm",""],["slot","start"],["defaultHref","/rechnungen"],["slot","end"],["color","primary",3,"click","disabled"],[1,"ion-padding"],["size","8"],[4,"ngIf","ngIfElse"],["message","\xC4nderungen gespeichert","duration","1500","position","bottom",3,"didDismiss","isOpen"],[1,"page-heading"],["fill","clear","size","small","color","primary",3,"click",4,"ngIf"],["lines","full",1,"base-form"],["position","stacked"],["datetime","rechnung-date"],[3,"keepContentsMounted"],["placeholder","R-2001",3,"ionInput","value"],["interface","popover",3,"ionChange","value"],[3,"value",4,"ngFor","ngForOf"],[1,"due-item"],["datetime","faellig-date"],["type","number","placeholder","z. B. 1999.00",3,"ionInput","value"],[1,"positions-header"],[1,"title"],["size","small","fill","outline","color","primary",3,"click"],[1,"position-list"],["class","position",4,"ngFor","ngForOf"],["lines","full",1,"sum-item"],["fill","clear","size","small","color","primary",3,"click"],["id","rechnung-date","presentation","date",3,"ionChange","value"],[3,"value"],["id","faellig-date","presentation","date",3,"ionChange","value"],[1,"position"],[1,"position-head"],[1,"label"],["size","small","fill","clear","color","medium",3,"click","disabled"],[1,"position-sum"],["lines","full"],["interface","popover","placeholder","Leistung ausw\xE4hlen",3,"ionChange","value"],["value",""],["class","catalog-preview",4,"ngIf"],["type","number",3,"ionInput","value"],["size","small","fill","clear","color","primary",3,"click"],[1,"catalog-preview"],[1,"catalog-title"],[1,"catalog-meta"],["class","catalog-desc",4,"ngIf"],[1,"catalog-desc"],["fixed",""],["size","12","size-md","4"],["size","12","size-md","8"],["placeholder","Bezeichnung",3,"ionInput","value"],["size","12"],["auto-grow","true","placeholder","optional",3,"ionInput","value"],["placeholder","Std",3,"ionInput","value"],[1,"missing"],[3,"click"]],template:function(t,n){if(t&1){let a=f();o(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",2),I(3,"ion-back-button",3),r(),o(4,"ion-title"),m(5,"Rechnung"),r(),o(6,"ion-buttons",4)(7,"ion-button",5),x("click",function(){return p(a),d(n.save())}),m(8,"Speichern"),r()()()(),o(9,"ion-content",6)(10,"ion-grid")(11,"ion-row"),I(12,"ion-col"),o(13,"ion-col",7),h(14,Se,43,15,"ng-container",8)(15,Ee,5,0,"ng-template",null,0,z),o(17,"ion-toast",9),x("didDismiss",function(){return p(a),d(n.closeToast())}),r()(),I(18,"ion-col"),r()()()}if(t&2){let a=M(16);c(7),g("disabled",!n.form()),c(7),g("ngIf",n.form())("ngIfElse",a),c(3),g("isOpen",n.toastOpen())}},dependencies:[X,le,re,Z,K,J,te,Y,ee,ue,ce,ie,H,Q,se,G,oe,W,ne,q,ae,me,F,B,A,j],styles:["[_nghost-%COMP%]   ion-toolbar[_ngcontent-%COMP%]{--border-width: 0 0 1px 0;--border-color: var(--ion-color-step-150)}[_nghost-%COMP%]   ion-content[_ngcontent-%COMP%]{display:block}.page-heading[_ngcontent-%COMP%]{font-size:1.6rem;font-weight:600;margin-bottom:12px}.base-form[_ngcontent-%COMP%]{margin-top:12px;border-radius:14px;overflow:hidden;border:1px solid var(--ion-color-step-150)}.due-item[_ngcontent-%COMP%]{--inner-padding-end: 0}.due-item[_ngcontent-%COMP%]   .due-picker[_ngcontent-%COMP%]{margin-top:8px}.due-item[_ngcontent-%COMP%]   ion-button[slot=end][_ngcontent-%COMP%]{margin-top:4px}.positions-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-top:24px;margin-bottom:12px}.positions-header[_ngcontent-%COMP%]   .title[_ngcontent-%COMP%]{font-weight:600;font-size:1.1rem}.position-list[_ngcontent-%COMP%]{display:grid;gap:16px}.position[_ngcontent-%COMP%]{border:1px solid var(--ion-color-step-150);border-radius:14px;padding:16px;background:var(--ion-item-background, #fff)}.position-head[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}.position-head[_ngcontent-%COMP%]   .label[_ngcontent-%COMP%]{font-weight:600}.position[_ngcontent-%COMP%]   ion-button[size=small][_ngcontent-%COMP%]{align-self:flex-start}.catalog-preview[_ngcontent-%COMP%]{background:var(--ion-color-step-50);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px;margin-bottom:8px}.catalog-title[_ngcontent-%COMP%]{font-weight:600}.catalog-meta[_ngcontent-%COMP%]{color:var(--ion-color-medium);font-size:.9rem}.catalog-desc[_ngcontent-%COMP%]{color:var(--ion-color-medium);font-size:.95rem;line-height:1.3}.position-sum[_ngcontent-%COMP%]{display:flex;justify-content:space-between;font-weight:600;margin-top:12px;padding-top:8px;border-top:1px solid var(--ion-color-step-150)}.sum-item[_ngcontent-%COMP%]{margin-top:20px;border-radius:12px;--background: var(--ion-color-step-50)}.missing[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:48px 0;text-align:center;color:var(--ion-color-medium)}"]});let l=_;return l})();export{Me as RechnungDetailPage};
